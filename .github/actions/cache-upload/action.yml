name: "Upload cache"
description: "Custom cache upload action"
inputs:
  key:
    description: "Cache key"
    required: true
  path:
    description: "A directory to upload"
    required: true
  folder:
    description: "s3 subfolder"
    default: cache
    required: false
  override:
    description: "Force override existing cache"
    default: false
    required: false

runs:
  using: "composite"
  steps:
    - name: Check cache
      id: check-s3-cache
      shell: bash -euxo pipefail {0}
      env:
        ARCHIVE: /tmp/uploads/${{ inputs.key }}.tar.zst
        OVERRIDE: ${{ inputs.override }}
        FOLDER: ${{ inputs.folder }}
        BUCKET: neon-github-dev
      run: |
        FILENAME=$(basename $ARCHIVE)
        
        S3_KEY=$(aws s3api list-objects-v2 --bucket ${BUCKET} --prefix ${FOLDER} | jq -r '.Contents[].Key' | grep ${FILENAME} | tail -1 || true)
        if [ -z "${S3_KEY}" ]; then
          echo "no cache hit"
          echo 'SKIP=false' >> $GITHUB_OUTPUT
          else
            if [ "${OVERRIDE}" = "true" ]; then
              echo "override existing cache"
              echo 'SKIP=false' >> $GITHUB_OUTPUT
            else
              echo "cache exists, skipping upload"
              echo 'SKIP=true' >> $GITHUB_OUTPUT
          fi
        fi

    - name: Prepare cache
      id: prepare-s3-cache
      if: ${{ steps.check-s3-cache.outputs.SKIP == 'false' }}
      shell: bash -euxo pipefail {0}
      env:
        SOURCE: ${{ inputs.path }}
        ARCHIVE: /tmp/uploads/${{ inputs.key }}.tar.zst
      run: |
        mkdir -p $(dirname $ARCHIVE)
        echo "" > manifest.txt
        echo "" > ignore.txt
        
        for i in ${SOURCE} 
        do
          echo "$i" >> manifest.txt
        done
        
        # split excluded folders to ignore.txt
        sed -i -e '/^!/{w ignore.txt' -e 'd}' manifest.txt
        
        # remove leading '!' identifier
        sed -i -e 's/^.//' ignore.txt
        
        # remove each excluded folder listed
        while IFS= read -r line; do
          rm -rf "$line"
        done <ignore.txt

        time /bin/tar --posix --use-compress-program zstdmt -cf ${ARCHIVE} --exclude manifest.txt --exclude ignore.txt -P -C ${GITHUB_WORKSPACE} --files-from manifest.txt

    - name: Upload cache
      id: upload-s3-cache
      if: ${{ steps.check-s3-cache.outputs.SKIP == 'false' }}
      shell: bash -euxo pipefail {0}
      env:
        ARCHIVE: /tmp/uploads/${{ inputs.key }}.tar.zst
        OVERRIDE: ${{ inputs.override }}
        FOLDER: ${{ inputs.folder }}
        BUCKET: neon-github-dev
      run: |
        FILENAME=$(basename $ARCHIVE)
        FILESIZE=$(du -sh ${ARCHIVE} | cut -f1)
        
        echo "${FILENAME} - ${FILESIZE}" >> ${GITHUB_STEP_SUMMARY}
        
        S3_KEY=$(aws s3api list-objects-v2 --bucket ${BUCKET} --prefix ${FOLDER} | jq -r '.Contents[].Key' | grep ${FILENAME} | tail -1 || true)
        if [ -z "${S3_KEY}" ]; then
          echo "uploading cache"
          time aws s3 mv --only-show-errors ${ARCHIVE} s3://${BUCKET}/${FOLDER}/${FILENAME}
          else
            if [ "${OVERRIDE}" = "true" ]; then
              echo "override existing cache"
              time aws s3 mv --only-show-errors ${ARCHIVE} s3://${BUCKET}/${FOLDER}/${FILENAME}
            else
              echo "cache exists, skipping upload"
          fi
        fi
